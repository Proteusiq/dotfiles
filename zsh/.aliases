#!/usr/bin/env bash

###############################################################################
# SHELL SHORTCUTS
###############################################################################

alias c="clear"
alias x="exit"
alias o="open ."
alias t="touch"
alias md="mkdir"
alias x+="chmod +x"
alias reload="source ~/.zshrc"
alias clip='pbcopy'
alias paste='pbpaste'
alias get="curl -O -L"

###############################################################################
# EDITORS
###############################################################################

alias v="nvim"
alias vi="nvim"
alias vim="nvim"
alias n="nvim"

###############################################################################
# MODERN CLI REPLACEMENTS
###############################################################################

alias cat="bat"
alias ls="eza --icons=always"
alias ll="eza -l"
alias la="eza -la"
alias tree="eza --tree"
alias top="btop"
alias du="ncdu"
alias python3="/opt/homebrew/opt/python@3.14/bin/python3.14"
alias python="/opt/homebrew/opt/python@3.14/bin/python3.14"

###############################################################################
# GIT - BASICS
###############################################################################

alias g="git"
alias ga="git add"
alias gb="git branch"
alias gf="git fetch"
alias gg="git grep"
alias gl="git log"
alias gm="git merge"
alias gr="git remote"
alias gs="git status"
alias gw="git whatchanged"

# adding
alias gaa="git add ."
alias gap="git add --patch"
alias gau="git add --update"

# branches
alias gbe="git branch --edit-description"
alias gbd="git branch -d"
alias gbdd="git branch -D"
alias gch="git checkout"
alias gcb="git checkout -b"
alias gbm="git branch --merged"
alias gbnm="git branch --no-merged"

# cherry-pick
alias gchp="git cherry-pick"

# clone
alias gcl="git clone"

# commit
alias gc="git commit -am"
alias gcm="git commit --amend --message"

# diff
alias gd="git diff --color"
alias gdt="git difftool"
alias gitfix="git diff --name-only | uniq | xargs code"

# grep
alias ggl="git grep --line-number"
alias ggg="git grep --break --heading --line-number"

# log
alias glg="git log --graph"
alias glo="git log --oneline"
alias changelog='git log --pretty=format:"%h %ad%x09%an%x09%s" --date=short'

# merge
alias gmc="git merge --continue"
alias gma="git merge --abort"

# pull
alias gpl="git pull"

# push
alias gp="git push"
alias gpu="git push -u origin"
alias undopush="git push -f origin HEAD^:master"

# rebase
alias gre="git rebase"

# remote
alias gra="git remote add origin"

# stash
alias gst="git stash"
alias gsa="git stash apply"
alias gsp="git stash pop"
alias gsd="git stash drop"

# github (hub)
alias gbi="git browse -- issues"
alias gpr="git pull-request"

###############################################################################
# DIRECTORY NAVIGATION
###############################################################################

alias dev="cd ~/dev"
alias work="cd ~/dev/work"
alias desk="cd ~/desktop"
alias docs="cd ~/documents"
alias dl="cd ~/downloads"
alias home="cd ~"
alias dots="cd ~/dotfiles"

###############################################################################
# PACKAGE MANAGERS
###############################################################################

# yarn
alias y="yarn"
alias yi="yarn init"
alias ya="yarn add"
alias yad="yarn add --dev"
alias yga="yarn global add"
alias yr="yarn run"
alias ys="yarn start"
alias yis="yarn install && yarn start"
alias yrm="yarn remove"
alias yup="yarn upgrade"
alias ycl="yarn clean"
alias ych="yarn check"
alias yt="yarn test"
alias ycc="yarn cache clean"

# pnpm
alias pn="pnpm"
alias pna="pnpm add"
alias pnr="pnpm run"
alias pni="pnpm install"

# python (uv)
alias pip="uv pip"

###############################################################################
# GNU COREUTILS (macOS replacements)
###############################################################################

# file output
alias tail="gtail -F"
alias split="gsplit"
alias csplit="gcsplit"

# checksums
alias sum="gsum"
alias cksum="cksum"
alias md5sum="gmd5sum"
alias sha1sum="gsha1sum"

# field operations
alias cut="gcut"
alias join="gjoin"

# basic file ops
alias cp="gcp -v"
alias mv="gmv -v"
alias rm="grm -v"
alias shred="gshred"

# special filetypes
alias link="glink"
alias unlink="gunlink"
alias mkdir="gmkdir -v"
alias rmdir="grmdir -v"
alias readlink="greadlink"

# file attributes
alias chmod="gchmod -v"
alias chown="gchown -v"
alias chgrp="gchgrp -v"
alias touch="gtouch"

# disk usage
alias df="gdf"
alias stat="gstat"
alias sync="gsync"
alias truncate="gtruncate"

# printing text
alias echo="gecho"

# redirection
alias tee="gtee"

# text processing
alias awk="gawk"
alias grep="ggrep --color"
alias sed="gsed"

# links
alias ln="gln"
alias ln-sym="gln -nsf"

# findutils
alias find="gfind"
alias locate="glocate"
alias updatedb="gupdatedb"
alias xargs="gxargs"

# binutils
alias addr2line="gaddr2line"
alias ar="gar"
alias c++filt="gc++filt"
alias dlltool="gdlltool"
alias nlmconv="gnlmconv"
alias nm="gnm"
alias objcopy="gobjcopy"
alias objdump="gobjdump"
alias ranlib="granlib"
alias readelf="greadelf"
alias size="gsize"
alias strings="gstrings"
alias strip="gstrip"

# archive
alias tar="gtar"

# which
alias which="gwhich"

###############################################################################
# TMUX
###############################################################################

alias iexit='tmux kill-session -t $(tmux display-message -p "#S")'
alias ix=iexit
alias ikill='tmux kill-server'
alias ik=ikill
alias iswitch='tmux choose-session'
alias ipop='tmux display-popup -E "cd $(tmux display -p -F "#{pane_current_path}") && tmux new-session -A -s scratch"'

###############################################################################
# macOS SPECIFIC
###############################################################################

# finder
alias show="defaults write com.apple.finder AppleShowAllFiles -bool true && killall Finder"
alias hide="defaults write com.apple.finder AppleShowAllFiles -bool false && killall Finder"
alias showdesktop="defaults write com.apple.finder CreateDesktop -bool true && killall Finder"
alias hidedesktop="defaults write com.apple.finder CreateDesktop -bool false && killall Finder"

# spotlight
alias spotoff="sudo mdutil -a -i off"
alias spoton="sudo mdutil -a -i on"

# system
alias afk="/System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -suspend"
alias stfu="osascript -e 'set volume output muted true'"
alias restart="sudo reboot"
alias bye="sudo shutdown -r now"

# cleanup
alias rm_ds="find . -name '*.DS_Store' -type f -ls -delete"
alias xcodepurge="rm -rf ~/Library/Developer/Xcode/DerivedData"
alias chromekill="ps ux | grep '[C]hrome Helper --type=renderer' | grep -v extension-process | tr -s ' ' | cut -d ' ' -f2 | xargs kill"

# pdf
alias mergepdf="/System/Library/Automator/Combine\ PDF\ Pages.action/Contents/Resources/join.py"

###############################################################################
# MISC ALIASES
###############################################################################

alias snowsql="$HOME/Applications/SnowSQL.app/Contents/MacOS/snowsql"
alias f=fuck
alias tk="take"
alias clean=clean_pycache
alias activate=activate_venv
alias pg=purge

###############################################################################
# FUNCTIONS
###############################################################################

# make new dir and cd into it
take() {
    mkdir -p $1
    cd $1 || exit
}

# go up N directories
up() {
    local cdir="$(pwd)"
    if [[ "${1}" == "" ]]; then
        cdir="$(dirname "${cdir}")"
    elif ! [[ "${1}" =~ ^[0-9]+$ ]]; then
        echo "Arg must be a number"
    elif ! [[ "${1}" -gt "0" ]]; then
        echo "a POSITIVE number"
    else
        for i in {1..${1}}; do
            local ncdir="$(dirname "${cdir}")"
            if [[ "${cdir}" == "${ncdir}" ]]; then
                break
            else
                cdir="${ncdir}"
            fi
        done
    fi
    cd "${cdir}" || exit
}

# yazi wrapper - cd to dir on exit
yy() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
    yazi "$@" --cwd-file="$tmp"
    if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
        cd -- "$cwd" || exit
    fi
    rm -f -- "$tmp"
}

# git clone and cd into repo
git() {
    if [ $1 = "clone" ]; then
        command git $@ && cd "$(basename "$_" .git)"
    else
        command git $@
    fi
}

# gitignore.io
gi() {
    curl -L -s https://www.gitignore.io/api/$@
}

# create a remote repo
create-repo() {
    echo "Enter name for new repo"
    read -r REPONAME
    echo "Do you want to make it private? (y/n)"
    read -r -n PRIVATE_ANSWER

    if [[ "$PRIVATE_ANSWER" =~ ^[Yy]$ ]]; then
        PRIVATE_TF=true
    else
        PRIVATE_TF=false
    fi

    curl -u proteusiq https://api.github.com/user/repos -d "{\"name\": \"$REPONAME\", \"private\": $PRIVATE_TF}" >/dev/null

    git init 1>/dev/null
    gi macos,visualstudiocode >>.gitignore 1>/dev/null
    print_success ".gitignore added"
    git add . 1>/dev/null
    git commit -m "initial commit" 1>/dev/null
    git remote add origin https://github.com/proteusiq/$REPONAME.git 1>/dev/null
    git push -u origin main --force 1>/dev/null

    sleep 0.5
    print_success "\nRepo created"
    print_in_cyan "You can view your new repo at https://github.com/proteusiq/$REPONAME.git"
}

# rename a remote git branch
rename-branch() {
    current_name=$1
    new_name=$2
    git branch -m $current_name $new_name
    git push origin :$current_name $new_name
    git push origin -u $new_name
}

# animated gifs from video
gifify() {
    if [[ -n "$1" ]]; then
        if [[ $2 == '--good' ]]; then
            ffmpeg -i "$1" -r 10 -vcodec png out-static-%05d.png
            time convert -verbose +dither -layers Optimize -resize 900x900\> out-static*.png GIF:- | gifsicle --colors 128 --delay=5 --loop --optimize=3 --multifile - >"$1.gif"
            rm out-static*.png
        else
            ffmpeg -i "$1" -s 600x400 -pix_fmt rgb24 -r 10 -f gif - | gifsicle --optimize=3 --delay=3 >"$1.gif"
        fi
    else
        echo "Usage: gifify <input_movie.mov>"
    fi
}

# empty trash
emptytrash() {
    print_header "Emptying trashes..."
    sudo rm -rfv /Volumes/*/.Trashes 1>/dev/null
    rm -rfv ~/.Trash/* 1>/dev/null
    sudo rm -v /private/var/vm/sleepimage 1>/dev/null
}

# activate venv or .venv
activate_venv() {
    local dir=$PWD
    local found=0

    while [[ "$dir" != "/" && $found -eq 0 ]]; do
        if [[ -f "$dir/venv/bin/activate" ]]; then
            source "$dir/venv/bin/activate"
            found=1
            break
        elif [[ -f "$dir/.venv/bin/activate" ]]; then
            source "$dir/.venv/bin/activate"
            found=1
            break
        else
            dir=$(dirname "$dir")
        fi
    done

    if [[ $found -eq 0 ]]; then
        echo "No Python virtual environment found."
    fi
}

# load .env file
setenv() {
    local env_file=".env"
    local use_op=false

    while [[ "$#" -gt 0 ]]; do
        case $1 in
        --key) use_op=true ;;
        *)
            echo "Unknown parameter: $1"
            return 1
            ;;
        esac
        shift
    done

    if [[ ! -f "$env_file" ]]; then
        echo "$env_file not found"
        return 1
    fi

    process_env_line() {
        local line=$1
        local var_name="${line%%=*}"
        local var_value="${line#*=}"

        if $use_op && [[ $var_value =~ op://.*$ ]]; then
            var_value="${var_value//[\"\']/}"
            var_value="$(op read "$var_value")"
        fi

        export "$var_name=$var_value"
    }

    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ "$line" =~ ^[[:space:]]*# || -z "$line" ]] && continue
        process_env_line "$line"
    done < <(grep -v '^[[:space:]]*$' "$env_file")

    echo "Environment variables loaded from $env_file"
}

# unload .env file
unsetenv() {
    local env_file=".env"

    if [[ ! -f "$env_file" ]]; then
        echo "$env_file not found"
        return 1
    fi

    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ "$line" =~ ^[[:space:]]*# || -z "$line" ]] && continue
        local var_name="${line%%=*}"
        unset "$var_name"
    done < <(grep -v '^[[:space:]]*$' "$env_file")

    echo "Environment variables unset from $env_file"
}

# remove __pycache__ directories
clean_pycache() {
    local target_dir=$1

    if [ -z "$target_dir" ]; then
        echo "Usage: clean_pycache <directory>"
        return 1
    fi

    echo "Searching for __pycache__ directories under $target_dir..."
    find $target_dir -type d -name '__pycache__' -exec rm -rf {} +
}

# delete files matching a pattern (with preview)
# usage: purge "*.csv" [directory]
purge() {
    local pattern=$1
    local target_dir=${2:-.}

    if [[ -z "$pattern" ]]; then
        echo "Usage: purge <pattern> [directory]"
        echo "Example: purge '*.csv' ."
        return 1
    fi

    local files
    files=$(find "$target_dir" -name "$pattern" -type f 2>/dev/null)

    if [[ -z "$files" ]]; then
        echo "No files matching '$pattern' found in $target_dir"
        return 0
    fi

    echo "Files to be deleted:"
    echo "$files" | while read -r f; do echo "  $f"; done
    echo ""
    echo -n "Delete these files? [y/N] "
    read -r confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        find "$target_dir" -name "$pattern" -type f -delete
        echo "Deleted files matching '$pattern'"
    else
        echo "Aborted"
    fi
}

# run dotfiles install script
alias update='~/dotfiles/install.sh'
